<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>FastRTC LAN Video Call</title>
</head>
<body>
<h2>FastRTC 1-on-1 LAN Video Call</h2>
<input type="text" id="room" placeholder="Enter room name" />
<br><br>
<button id="start">Start Call</button>
<button id="join">Join Call</button>
<br><br>
<video id="local" autoplay muted width="320" height="240"></video>
<video id="remote" autoplay width="320" height="240"></video>

<script>
let pc, ws;

async function createPeerConnection(roomId) {
    ws = new WebSocket(`ws://10.5.25.237:8080/signal/${roomId}`); // Replace with your server LAN IP
    pc = new RTCPeerConnection();

    // Display remote stream
    pc.ontrack = event => {
        document.getElementById("remote").srcObject = event.streams[0];
    };

    // Get local webcam + mic
    const localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    document.getElementById("local").srcObject = localStream;
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    // ICE candidates
    pc.onicecandidate = event => {
        if (event.candidate) {
            ws.send(JSON.stringify({ type: "candidate", candidate: event.candidate }));
        }
    };

    ws.onmessage = async msg => {
        const data = JSON.parse(msg.data);
        if (data.type === "offer") {
            await pc.setRemoteDescription({ type: "offer", sdp: data.sdp });
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            ws.send(JSON.stringify({ type: "answer", sdp: answer.sdp }));
        }
        else if (data.type === "answer") {
            await pc.setRemoteDescription({ type: "answer", sdp: data.sdp });
        }
        else if (data.type === "candidate") {
            try { await pc.addIceCandidate(data.candidate); }
            catch(e){ console.error("ICE candidate error:", e); }
        }
    };
}

document.getElementById("start").onclick = async () => {
    const roomId = document.getElementById("room").value;
    await createPeerConnection(roomId);
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    ws.onopen = () => { ws.send(JSON.stringify({ type: "offer", sdp: offer.sdp })); };
};

document.getElementById("join").onclick = async () => {
    const roomId = document.getElementById("room").value;
    await createPeerConnection(roomId);
    ws.onopen = () => { ws.send(JSON.stringify({ type: "get-offer" })); };
};
</script>
</body>
</html>
